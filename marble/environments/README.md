# Minecraft environment setup (cluster runbook)

This is a fuller record of everything we did to get the Minecraft environment running on the cluster, so others can reproduce without hunting through logs.

## 0) Repo & workspace
- Clone your fork (ours: `git@github.com:Tenshi0x0/MARBLE.git`).
- Work inside `/u/tchen19/MARBLE/marble` when running (many relative paths assume this).
- Ensure `MARBLE/marble/logs` and `MARBLE/marble/result/minecraft` exist:
  ```bash
  mkdir -p MARBLE/marble/logs MARBLE/marble/result/minecraft
  ```

## 1) Conda env (Python)
- Activate:  
  `source /sw/user/python/miniforge3-pytorch-24.11.3/etc/profile.d/conda.sh && conda activate comlrl`
- Install project deps:
  ```bash
  cd /u/tchen19/MARBLE
  pip install -e .
  pip install ruamel.yaml                      # missing import encountered
  pip install 'torchvision==0.21.0' --no-deps  # fixes torchvision::nms missing with torch 2.6.0+cpu
  python - <<'PY'
  from torchvision.ops import nms
  print("nms ok")
  PY
  ```

## 2) Node.js + Mineflayer stack
- Install node 18 in the same env: `conda install -y -c conda-forge nodejs=18`
- MC bot deps (run once):
  ```bash
  cd /u/tchen19/MARBLE/marble/environments/minecraft_utils
  npm install mineflayer mineflayer-pathfinder mineflayer-collectblock mineflayer-pvp minecrafthawkeye vec3 socks5-client minecraft-data
  ```

## 3) Data files required (must exist)
Place these in `MARBLE/data/`:
- `building_blue_print.json`
- `blueprint_description_all.json`
- `map.json`, `map_description.json`, `score.json` (already present)
- `url_prefix.json` (autogenerated but directory must exist)
- `dig_item.json`, `mcData.json` if used by your configs

## 4) Minecraft server (Paper 1.19.2)
- Jar location used: `~/mc-server/paper-1.19.2-385.jar`
- First run to accept EULA, then set in `server.properties`:
  - `online-mode=false`
  - `enable-command-block=true`
  - `spawn-protection=0`
  - `gamemode=creative`
  - `difficulty=peaceful`
  - `allow-flight=true`
  - `server-port=25565` (match config)
- OP bots: `build_judge`, `agent1`, `agent2`, `agent3`.
- Start server for a run:
  ```bash
  java -Xms4G -Xmx4G -jar ~/mc-server/paper-1.19.2-385.jar nogui
  ```

## 5) API keys
- We used `DEEPSEEK_API_KEY` for `deepseek/deepseek-chat` via litellm.
- Set before running: `export DEEPSEEK_API_KEY="..."`.
- If you switch to other models, set the corresponding API keys (OpenAI/Together/etc.).

## 6) Running a job (interactive or sbatch)
Example (what we used in sbatch):
```bash
source /sw/user/python/miniforge3-pytorch-24.11.3/etc/profile.d/conda.sh && conda activate comlrl
export DEEPSEEK_API_KEY=...   # required
BASE=$HOME/MARBLE
LOGDIR=$BASE/logs
mkdir -p "$LOGDIR"
cd $BASE/marble
java -Xms4G -Xmx4G -jar $HOME/mc-server/paper-1.19.2-385.jar nogui > "$LOGDIR/mc_server.log" 2>&1 &
MC_PID=$!
sleep 25
python main.py --config_path configs/test_config_minecraft/test_config_deepseek_0.yaml > "$LOGDIR/marble_mc.log" 2>&1 || true
if ps -p $MC_PID > /dev/null 2>&1; then kill $MC_PID; fi
```

Slurm template (single GPU node):
```bash
sbatch --account=bevi-dtai-gh --partition=ghx4 --nodes=1 --gpus-per-node=1 \
  --ntasks=1 --ntasks-per-node=1 --cpus-per-task=64 --mem=100g --time=24:00:00 \
  --wrap="bash -lc 'set -euo pipefail
  source /sw/user/python/miniforge3-pytorch-24.11.3/etc/profile.d/conda.sh && conda activate comlrl
  export DEEPSEEK_API_KEY=...
  BASE=$HOME/MARBLE; LOGDIR=$BASE/logs; mkdir -p \"$LOGDIR\"
  cd $BASE/marble
  java -Xms4G -Xmx4G -jar $HOME/mc-server/paper-1.19.2-385.jar nogui > \"$LOGDIR/mc_server.log\" 2>&1 &
  MC_PID=$!; sleep 25
  python main.py --config_path configs/test_config_minecraft/test_config_deepseek_0.yaml > \"$LOGDIR/marble_mc.log\" 2>&1 || true
  if ps -p $MC_PID > /dev/null 2>&1; then kill $MC_PID; fi'"
```

## 7) Known pitfalls & fixes (encountered)
- `ModuleNotFoundError: ruamel` → `pip install ruamel.yaml`.
- `torchvision::nms does not exist` → install `torchvision==0.21.0` (matching torch 2.6.0+cpu).
- Relative paths (e.g., `../data/url_prefix.json`) → run from `MARBLE/marble`.
- Logging path missing (`/marble/logs/app.log`) → `mkdir -p MARBLE/marble/logs`.
- Output path missing → `mkdir -p MARBLE/marble/result/minecraft`.
- Ignore large node deps → `.gitignore` includes `marble/environments/minecraft_utils/node_modules/`.

## 8) Config used
- Example config added: `configs/test_config_minecraft/test_config_deepseek_0.yaml`
  - LLM: `deepseek/deepseek-chat`
  - Ports: MC server 25565, agents 5000/5001/5002
  - Task: Minecraft building (task_id 0)
